{% load static humanize %}
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BaseCalc - Nikkei Bias</title>
    <!-- 共通CSSの読み込み -->
    <link rel="stylesheet" href="{% static 'common/css/layout.css' %}">
    <link rel="stylesheet" href="{% static 'basecalc/css/style.css' %}">
</head>
<body>
    <div class="app-container">
        <header class="header">
            <h1>
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue">
                    <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                    <line x1="8" y1="21" x2="16" y2="21"></line>
                    <line x1="12" y1="17" x2="12" y2="21"></line>
                </svg>
                BaseCalc
            </h1>
            <a href="/" class="home-icon" aria-label="Home">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                    <polyline points="9 22 9 12 15 12 15 22"></polyline>
                </svg>
            </a>
        </header>

        <main class="content">
            {% if error %}
            <div class="card" style="border-left: 4px solid var(--color-accent-red);">
                <div class="card-title text-red">Error Occurred</div>
                <div style="margin-top: 8px; color: #fca5a5; font-size: 0.95rem;">{{ error }}</div>
                <div style="margin-top: 16px; text-align: right;">
                    <a href="?update=true" class="btn-base btn-outline">Retry</a>
                </div>
            </div>
            {% else %}

            <!-- 1. Hero / Valuation (No Price) -->
            <div class="hero-card status-{{ data.regime }}" id="hero-card">
                <div class="hero-label">Market Evaluation</div>
                <div class="hero-value" data-field="valuation_label">{{ data.valuation_label }}</div>
                <div id="regime-note" style="margin-top: 12px;" {% if not data.regime_note %}hidden{% endif %}>
                    <span style="background: rgba(251, 191, 36, 0.15); color: #fbbf24; padding: 6px 16px; border-radius: 99px; font-size: 0.85rem; font-weight: 600; border: 1px solid rgba(251, 191, 36, 0.3);">
                        ⚠️ <span data-field="regime_note">{{ data.regime_note|default:"" }}</span>
                    </span>
                </div>
            </div>

            <!-- 2. Independent Price Display -->
            <div class="price-display">
                <span class="price-label">Current Price (Investing.com)</span>
                <div class="price-value" id="current-price" data-field="price_display">{{ data.price_display|default:"" }}</div>
                <div id="price-warning" class="text-red" style="margin-top: 8px; font-size: 0.85rem;" hidden>
                    価格取得に失敗しました。更新を停止しました。
                </div>
            </div>

            <!-- 3. Controls -->
            <form method="get" action="" class="erp-form">
                <input type="hidden" name="price" value="{{ price_param|default:'' }}" data-field="price_param">
                <!-- Row 1: Inputs -->
                <div class="control-row">
                    <select name="erp_method" class="erp-input erp-select" aria-label="ERP算出方法">
                        <option value="method_a" {% if erp_method == "method_a" %}selected{% endif %}>A 益回り</option>
                        <option value="method_b" {% if erp_method == "method_b" %}selected{% endif %}>B 益回り+成長</option>
                        <option value="method_c" {% if erp_method == "method_c" %}selected{% endif %}>C 配当+成長</option>
                    </select>
                    {% with growth_selected=erp_growth_input|default:"2.1" %}
                    <input type="text" class="erp-input input-growth" id="growth-fixed" value="0.00" readonly {% if erp_method != "method_a" and erp_method != "method_c" %}hidden{% endif %}>
                    <select name="erp_growth" class="erp-input erp-select input-growth" id="growth-select" aria-label="g 選択" {% if erp_method != "method_b" %}hidden disabled{% endif %}>
                        <option value="1.7" {% if growth_selected == "1.7" %}selected{% endif %}>1.7</option>
                        <option value="2.1" {% if growth_selected == "2.1" %}selected{% endif %}>2.1</option>
                        <option value="2.7" {% if growth_selected == "2.7" %}selected{% endif %}>2.7</option>
                    </select>
                    {% endwith %}
                </div>
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3 class="section-title" style="margin: 0;">Range Tuning</h3>
                    </div>

                    <details style="margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; overflow: hidden;">
                        <summary style="padding: 10px 16px; background: rgba(255,255,255,0.05); cursor: pointer; display: flex; align-items: center; justify-content: space-between; font-size: 0.9rem; font-weight: 500; list-style: none; color: var(--color-text-main);">
                            <span style="display: flex; align-items: center; gap: 8px;">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <line x1="12" y1="16" x2="12" y2="12"></line>
                                    <line x1="12" y1="8" x2="12.01" y2="8"></line>
                                </svg>
                                設定の説明と推奨値
                            </span>
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="opacity: 0.5;">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                        </summary>
                        <div style="padding: 16px; background: rgba(0,0,0,0.2); font-size: 0.85rem; line-height: 1.6; color: var(--color-text-muted);">
                            <p style="margin-top: 0; margin-bottom: 12px;">GROWTH_CORE_RATIO_DEFAULT（推奨0.8〜1.2）とWIDE（推奨0.6〜1.4）は、適正レンジ幅を決める倍率です。1.0を基準に、値を大きくすると範囲が広がり、小さくすると狭まります。</p>
                            <p style="margin-bottom: 12px;">WideはCore以上の設定が推奨され、下回るとCore幅になります。実レンジには上下限（Core:0.1〜0.5%、Wide:0.2〜1.0%）があります。まずは1.0から始め、広すぎる場合はCore→Wideの順で下げて調整してください。</p>
                        </div>
                    </details>
                    <div class="data-list">
                        <div class="data-row">
                            <div class="label-group">
                                <span class="label-main">GROWTH_CORE_RATIO</span>
                                <span class="label-sub">コアレンジの幅を決める係数です。推奨 0.8-1.2。</span>
                            </div>
                            <input type="number" name="growth_core_ratio" class="erp-input input-value" step="0.1" min="0.1" max="2.0" value="{{ growth_core_ratio_input|default:'1.0' }}" data-field="growth_core_ratio_input">
                        </div>
                        <div class="data-row">
                            <div class="label-group">
                                <span class="label-main">GROWTH_WIDE_RATIO</span>
                                <span class="label-sub">ワイドレンジの幅を決める係数です。推奨 0.6-1.4。</span>
                            </div>
                            <input type="number" name="growth_wide_ratio" class="erp-input input-value" step="0.1" min="0.1" max="2.0" value="{{ growth_wide_ratio_input|default:'1.0' }}" data-field="growth_wide_ratio_input">
                        </div>
                    </div>
                </div>
                <!-- Row 2: Actions -->
                <div class="action-row">
                    <button type="submit" class="btn-base btn-primary">Apply ERP</button>
                    <a href="?update=true&erp_method={{ erp_method }}{% if erp_growth_input %}&erp_growth={{ erp_growth_input }}{% endif %}{% if growth_core_ratio_input %}&growth_core_ratio={{ growth_core_ratio_input }}{% endif %}{% if growth_wide_ratio_input %}&growth_wide_ratio={{ growth_wide_ratio_input }}{% endif %}{% if price_param %}&price={{ price_param }}{% endif %}" class="btn-base btn-outline" id="price-refresh">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M23 4v6h-6"></path>
                            <path d="M1 20v-6h6"></path>
                            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                        </svg>
                        Refresh
                    </a>
                </div>
            </form>

            <!-- 4. Fair Value Ranges -->
            <div class="card fair-value-card">
                <!-- Fair Range Detail -->
                <div class="valuation-section">
                    <h3 class="section-title">Fair Value Ranges</h3>
                    <div class="data-list">
                        <div class="data-row range-row">
                            <div class="label-group">
                                <span class="label-main">Fair Range (Core)</span>
                                <span class="label-sub">適正レンジ（コア ±{{ data.growth_core_width_percent|floatformat:2 }}%）</span>
                            </div>
                            <div class="range-values">
                                <span class="range-val text-blue" data-field="fair_price_core_low_display">{% if data.fair_price_core_low_display %}{{ data.fair_price_core_low_display }}{% endif %}</span>
                                <span class="range-sep text-muted">~</span>
                                <span class="range-val text-blue" data-field="fair_price_core_high_display">{% if data.fair_price_core_high_display %}{{ data.fair_price_core_high_display }}{% endif %}</span>
                            </div>
                        </div>
                        <div class="data-row range-row">
                            <div class="label-group">
                                <span class="label-main">Fair Range (Wide)</span>
                                <span class="label-sub">適正レンジ（ワイド ±{{ data.growth_wide_width_percent|floatformat:2 }}%）</span>
                            </div>
                            <div class="range-values">
                                <span class="range-val text-blue" data-field="fair_price_wide_low_display">{% if data.fair_price_wide_low_display %}{{ data.fair_price_wide_low_display }}{% endif %}</span>
                                <span class="range-sep text-muted">~</span>
                                <span class="range-val text-blue" data-field="fair_price_wide_high_display">{% if data.fair_price_wide_high_display %}{{ data.fair_price_wide_high_display }}{% endif %}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3 class="section-title">B 益回り+成長率（g）シナリオ</h3>
                <div class="data-list">
                    <div class="data-row">
                        <div class="label-group">
                            <span class="label-main">保守的シナリオ（PP寄り）</span>
                            <span class="label-sub">内訳：0.7% + 1.0%</span>
                        </div>
                        <span class="data-value">1.7<span class="unit">%</span></span>
                    </div>
                    <div class="data-row">
                        <div class="label-group">
                            <span class="label-main">中間シナリオ（レンジ中点）</span>
                            <span class="label-sub">内訳：0.65% + 1.5%</span>
                        </div>
                        <span class="data-value">2.1<span class="unit">%</span></span>
                    </div>
                    <div class="data-row">
                        <div class="label-group">
                            <span class="label-main">目標整合シナリオ（TN寄り）</span>
                            <span class="label-sub">内訳：0.7% + 2.0%</span>
                        </div>
                        <span class="data-value">2.7<span class="unit">%</span></span>
                    </div>
                </div>
            </div>

            <!-- 5. Market Conditions -->
            <details class="card">
                <summary class="card-header">
                    <div class="card-icon" style="color: var(--color-accent-amber);">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                            <polyline points="17 6 23 6 23 12"></polyline>
                        </svg>
                    </div>
                    <div class="card-title">Market Conditions</div>
                    <svg class="accordion-toggle" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                </summary>
                <div class="accordion-content">
                    <div class="data-list">
                        <div class="data-row">
                            <div class="label-group">
                                <span class="label-main">JGB 10Y</span>
                                <span class="label-sub">日本国債10年利回り</span>
                            </div>
                            <span class="data-value" data-field="jgb10y_yield_percent">{% if data.jgb10y_yield_percent %}{{ data.jgb10y_yield_percent }}<span class="unit">%</span>{% endif %}</span>
                        </div>
                        <div class="data-row">
                            <div class="label-group">
                                <span class="label-main">Forward PER</span>
                                <span class="label-sub">予想PER（指数ベース）</span>
                            </div>
                            <span class="data-value" data-field="forward_per">{{ data.forward_per|default:"" }}<span class="unit">x</span></span>
                        </div>
                        <div class="data-row">
                            <div class="label-group">
                                <span class="label-main">Dividend Yield</span>
                                <span class="label-sub">配当利回り（指数ベース）</span>
                            </div>
                            <span class="data-value" data-field="dividend_yield_index_percent">{% if data.dividend_yield_index_percent %}{{ data.dividend_yield_index_percent|floatformat:2 }}<span class="unit">%</span>{% endif %}</span>
                        </div>
                    </div>
                </div>
            </details>

            <!-- 6. Calculation Evidence -->
            <details class="card">
                <summary class="card-header">
                    <div class="card-icon" style="color: var(--color-accent-purple);">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="18" y1="20" x2="18" y2="10"></line>
                            <line x1="12" y1="20" x2="12" y2="4"></line>
                            <line x1="6" y1="20" x2="6" y2="14"></line>
                        </svg>
                    </div>
                    <div class="card-title">Calculation Evidence</div>
                    <svg class="accordion-toggle" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                </summary>
                
                <div class="accordion-content">
                    <!-- Index Base -->
                    <div class="valuation-section">
                        <h3 class="section-title">Index Base (Nikkei Official)</h3>
                        <div class="data-list">
                            <div class="data-row">
                                <div class="label-group">
                                    <span class="label-main">Forward EPS</span>
                                    <span class="label-sub">予想EPS（指数ベース）</span>
                                </div>
                                <span class="data-value" data-field="forward_eps_display">{% if data.forward_eps_display %}{{ data.forward_eps_display }}{% endif %}</span>
                            </div>
                            <div class="data-row">
                                <div class="label-group">
                                    <span class="label-main">Earnings Yield</span>
                                    <span class="label-sub">益利回り（予想/指数ベース）</span>
                                </div>
                                <span class="data-value" data-field="earnings_yield_forward_from_eps">{{ data.earnings_yield_forward_from_eps|floatformat:4|default:"" }}</span>
                            </div>
                            <div class="data-row">
                                <div class="label-group">
                                    <span class="label-main">Implied Growth</span>
                                    <span class="label-sub">暗黙成長率（指数ベース）</span>
                                </div>
                                <span class="data-value" data-field="g_implied_index">{{ data.g_implied_index|floatformat:4|default:"" }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </details>

            <!-- 7. Analysis Summary (Moved to Bottom) -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon" style="color: var(--color-accent-blue);">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                            <line x1="8" y1="21" x2="16" y2="21"></line>
                            <line x1="12" y1="17" x2="12" y2="21"></line>
                        </svg>
                    </div>
                    <div class="card-title">Analysis Summary</div>
                </div>
                
                <div class="summary-grid">
                    <div class="metric-box">
                        <label>Fair Value (Mid)</label>
                        <div class="value text-blue" data-field="fair_price_mid">{% if data.fair_price_mid %}{{ data.fair_price_mid|floatformat:0|intcomma }}{% endif %}</div>
                    </div>
                    <div class="metric-box">
                        <label>Gap</label>
                        <div class="value {% if data.fair_price_gap_pct > 0 %}text-red{% else %}text-green{% endif %}" data-field="fair_price_gap_pct" data-sync-class="true">
                            {% if data.fair_price_gap_pct %}{{ data.fair_price_gap_pct|floatformat:2 }}<span class="unit">%</span>{% endif %}
                        </div>
                    </div>
                     <div class="metric-box">
                        <label>Assumed ERP</label>
                        <div class="value text-purple" data-field="erp_percent">{% if data.erp_percent %}{{ data.erp_percent|floatformat:2 }}<span class="unit">%</span>{% endif %}</div>
                    </div>
                </div>
            </div>

            {% endif %}
        </main>
    </div>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const form = document.querySelector(".erp-form");
            const priceValue = document.getElementById("current-price");
            const priceInput = form ? form.querySelector('[name="price"]') : null;
            const refreshLink = document.getElementById("price-refresh");
            const STORAGE_KEY = "basecalc_current_price";
            const priceWarning = document.getElementById("price-warning");

            const setPriceWarning = (visible) => {
                if (!priceWarning) {
                    return;
                }
                priceWarning.hidden = !visible;
            };

            if (form) {
                const methodSelect = form.querySelector('[name="erp_method"]');
                const growthSelect = form.querySelector("#growth-select");
                const growthFixed = form.querySelector("#growth-fixed");
                if (methodSelect && growthSelect && growthFixed) {
                    const updateInputs = (method) => {
                        const needsGrowth = method === "method_b";
                        growthSelect.disabled = !needsGrowth;
                        growthSelect.hidden = !needsGrowth;
                        growthFixed.hidden = needsGrowth;
                    };

                    methodSelect.addEventListener("change", () => {
                        updateInputs(methodSelect.value);
                    });

                    updateInputs(methodSelect.value);
                }
            }

            const normalizePrice = (value) => {
                if (value === null || value === undefined) {
                    return null;
                }
                const cleaned = String(value).replace(/,/g, "");
                const parsed = parseInt(cleaned, 10);
                if (!Number.isFinite(parsed) || parsed <= 0) {
                    return null;
                }
                return parsed;
            };
            const formatPriceDisplay = (value) =>
                value.toLocaleString("en-US", {
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0,
                });
            const applyPrice = (value) => {
                if (!priceValue) {
                    return;
                }
                priceValue.textContent = formatPriceDisplay(value);
                if (priceInput) {
                    priceInput.value = String(value);
                }
            };
            const readStorage = () => {
                try {
                    return localStorage.getItem(STORAGE_KEY);
                } catch (e) {
                    return null;
                }
            };
            const writeStorage = (value) => {
                try {
                    localStorage.setItem(STORAGE_KEY, value);
                } catch (e) {}
            };

            const storedPrice = normalizePrice(readStorage());
            const inputPrice = priceInput ? normalizePrice(priceInput.value) : null;
            const initialPrice = storedPrice !== null ? storedPrice : inputPrice;
            if (initialPrice !== null) {
                applyPrice(initialPrice);
                writeStorage(String(initialPrice));
            }

            const parsePriceFromHtml = (html) => {
                const match = html.match(/current\s+Nikkei 225 Futures price is\s*([0-9.,]+)/i);
                if (!match) {
                    return null;
                }
                const raw = match[1].replace(/,/g, "");
                const value = parseFloat(raw);
                if (!Number.isFinite(value)) {
                    return null;
                }
                const floored = Math.floor(value);
                return floored > 0 ? floored : null;
            };
            const fetchLatestPrice = () => {
                return fetch("https://www.investing.com/indices/japan-225-futures", {
                    method: "GET",
                    mode: "cors",
                    credentials: "omit",
                    headers: {
                        Accept: "text/html",
                    },
                })
                    .then((response) => {
                        if (!response.ok) {
                            throw new Error("price fetch failed");
                        }
                        return response.text();
                    })
                    .then((html) => parsePriceFromHtml(html));
            };

            const buildUrlFromForm = (options = {}) => {
                const url = new URL(window.location.href);
                url.search = "";
                if (form) {
                    const formData = new FormData(form);
                    for (const [key, value] of formData.entries()) {
                        if (value !== "") {
                            url.searchParams.set(key, value);
                        }
                    }
                }
                if (options.update) {
                    url.searchParams.set("update", "true");
                }
                return url;
            };

            const syncFieldsFromDoc = (doc) => {
                const fields = document.querySelectorAll("[data-field]");
                fields.forEach((field) => {
                    const key = field.getAttribute("data-field");
                    const next = doc.querySelector(`[data-field="${key}"]`);
                    if (!next) {
                        return;
                    }
                    if (
                        field.tagName === "INPUT" ||
                        field.tagName === "SELECT" ||
                        field.tagName === "TEXTAREA"
                    ) {
                        field.value = next.value;
                    } else {
                        field.innerHTML = next.innerHTML;
                    }
                    if (field.hasAttribute("data-sync-class")) {
                        field.className = next.className;
                    }
                });

                const heroCard = document.getElementById("hero-card");
                const heroNext = doc.getElementById("hero-card");
                if (heroCard && heroNext) {
                    heroCard.className = heroNext.className;
                }

                const regimeNote = document.getElementById("regime-note");
                if (regimeNote) {
                    const noteText = regimeNote.querySelector('[data-field="regime_note"]');
                    const hasNote = noteText && noteText.textContent.trim() !== "";
                    regimeNote.hidden = !hasNote;
                }
            };

            const syncStoredPrice = () => {
                if (!priceInput) {
                    return;
                }
                const value = normalizePrice(priceInput.value);
                if (value !== null) {
                    writeStorage(String(value));
                }
            };

            const requestUpdate = async (url) => {
                try {
                    const response = await fetch(url.toString(), {
                        method: "GET",
                        headers: {
                            "X-Requested-With": "XMLHttpRequest",
                        },
                        cache: "no-store",
                    });
                    if (!response.ok) {
                        return;
                    }
                    const html = await response.text();
                    const doc = new DOMParser().parseFromString(html, "text/html");
                    syncFieldsFromDoc(doc);
                    syncStoredPrice();
                    window.history.replaceState({}, "", url.toString());
                } catch (e) {}
            };

            if (form) {
                form.addEventListener("submit", (event) => {
                    event.preventDefault();
                    const url = buildUrlFromForm();
                    requestUpdate(url);
                });
            }

            if (refreshLink) {
                refreshLink.addEventListener("click", async (event) => {
                    event.preventDefault();
                    setPriceWarning(false);
                    let latestPrice = null;
                    try {
                        latestPrice = await fetchLatestPrice();
                    } catch (e) {}
                    if (latestPrice === null) {
                        setPriceWarning(true);
                        return;
                    }
                    if (priceInput) {
                        priceInput.value = String(latestPrice);
                    }
                    writeStorage(String(latestPrice));
                    const url = buildUrlFromForm({ update: true });
                    requestUpdate(url);
                });
            }
        });
    </script>
</body>
</html>
